<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Linux Sysadmin</title><link href="http://www.linuxsysadmin.tk/" rel="alternate"></link><link href="http://www.linuxsysadmin.tk/feeds/desarrollo.atom.xml" rel="self"></link><id>http://www.linuxsysadmin.tk/</id><updated>2016-10-17T08:00:00+02:00</updated><entry><title>Python como una calculadora estadística</title><link href="http://www.linuxsysadmin.tk/2016/10/python-como-una-calculadora-estadistica.html" rel="alternate"></link><published>2016-10-17T08:00:00+02:00</published><updated>2016-10-17T08:00:00+02:00</updated><author><name>Gerard</name></author><id>tag:www.linuxsysadmin.tk,2016-10-17:2016/10/python-como-una-calculadora-estadistica.html</id><summary type="html">&lt;p&gt;El otro día me encontraba en mi trabajo con otra petición muy especial: se necesitaba un &lt;em&gt;check&lt;/em&gt; para &lt;strong&gt;Nagios&lt;/strong&gt; que contara las apariciones de cierto tipo de errores en un fichero de &lt;em&gt;log&lt;/em&gt;. Ese &lt;em&gt;check&lt;/em&gt; debía saltar en función de cuán alejado estaba el valor de las últimas 100 muestras.&lt;/p&gt;
&lt;p&gt;Guardar una muestra de valores en un fichero no supone ningún problema en &lt;strong&gt;Linux&lt;/strong&gt;. Sin embargo, hacer cálculos estadísticos en &lt;strong&gt;bash&lt;/strong&gt; es un suicidio. Eso nos obligaba a utilizar un lenguaje mas elaborado, pero existente en todas las máquinas: &lt;strong&gt;python&lt;/strong&gt;. Sin embargo, el módulo &lt;strong&gt;numpy&lt;/strong&gt; no estaba en todas las máquinas interesadas; instalarlo no era una opción. Así que me tocó programarlo a mí.&lt;/p&gt;
&lt;p&gt;Desempolvando mis apuntes de estadística en forma de &lt;a href="https://en.wikipedia.org/wiki/Standard_deviation"&gt;Wikipedia&lt;/a&gt;, tenemos lo siguiente:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;For a finite set of numbers, the standard deviation is found by taking the square root of the average of the squared deviations of the values from their average value.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Para los matemáticos, también hay la fórmula, aunque para mi, con el ejemplo me vale.&lt;/p&gt;
&lt;h2&gt;Un caso concreto&lt;/h2&gt;
&lt;p&gt;Tenemos el conjunto de valores del ejemplo: 2, 4, 4, 4, 5, 5, 7, 9. Vamos a necesitar su valor medio, que es 5 (la suma de los valores entre el número de valores).&lt;/p&gt;
&lt;p&gt;Obtenemos un nuevo conjunto de desviaciones de los valores respecto a la media: (2-5), (4-5), (4-5), (4-5), (5-5), (5-5), (7-5), (9-5). Para resumir, queda -3, -1, -1, -1, 0, 0, 2, 4.&lt;/p&gt;
&lt;p&gt;El siguiente paso es obtener los cuadrados de las desviaciones anteriores: 9, 1, 1, 1, 0, 0, 4, 16.&lt;/p&gt;
&lt;p&gt;De ese conjunto se saca la media y ya tenemos el cuadrado desviación estándar: (9+1+1+1+0+0+4+16)/8 = 32/8 = 4.&lt;/p&gt;
&lt;p&gt;Finalmente hacemos la raíz cuadrada y obtenemos la desviación estándar: 2.&lt;/p&gt;
&lt;h2&gt;Un script que calcule por nosotros&lt;/h2&gt;
&lt;p&gt;Vamos a simplificar el proceso anterior simplificando el proceso con 3 funciones:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Media&lt;/li&gt;
&lt;li&gt;Cuadrado de la desviación de un valor concreto&lt;/li&gt;
&lt;li&gt;Raíz cuadrada&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;La media se utiliza al principio para calcular las desviaciones, y al final, para hacer la media de las desviaciones cuadradas. La otra función va a ser una que nos dé la desviación de un valor al cuadrado, dado su media y el valor mismo.&lt;/p&gt;
&lt;p&gt;Con estas funciones es muy fácil de escribir un código legible, que vamos a guardar en un fichero &lt;em&gt;some_math.py&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;math&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mf"&gt;1.0&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;stdev&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;avg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;variance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;avg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;samples&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;math&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sqrt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;variance&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="n"&gt;values&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Average:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;average&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;StDev:&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;stdev&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Y solamente nos queda comprobar que funciona, previa concesión de permisos de ejecución.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gerard@aldebaran:~$ ./some_math.py 
Average: 5.0
StDev: 2.0
gerard@aldebaran:~$ 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Elegante y efectivo...&lt;/p&gt;</summary><category term="linux"></category><category term="python"></category><category term="media"></category><category term="desviación estándar"></category></entry><entry><title>Escribiendo bots para Telegram</title><link href="http://www.linuxsysadmin.tk/2016/08/escribiendo-bots-para-telegram.html" rel="alternate"></link><published>2016-08-08T10:00:00+02:00</published><updated>2016-08-08T10:00:00+02:00</updated><author><name>Gerard</name></author><id>tag:www.linuxsysadmin.tk,2016-08-08:2016/08/escribiendo-bots-para-telegram.html</id><summary type="html">&lt;p&gt;Aunque no está muy extendido, &lt;strong&gt;Telegram&lt;/strong&gt; es un magnífico cliente de mensajería instantánea. Tiene varios puntos a favor, como por ejemplo seguridad, rapidez y su condición de &lt;em&gt;libre&lt;/em&gt;. Lo que no se conoce tanto es que dispone de una &lt;em&gt;API&lt;/em&gt; para crear &lt;em&gt;bots&lt;/em&gt; que pueden responder automáticamente a sus usuarios.&lt;/p&gt;
&lt;p&gt;La variedad de usos que se dan mediante estos &lt;em&gt;bots&lt;/em&gt; es muy variada. Personalmente he visto juegos, asistentes virtuales e incluso lo he usado para tener a mano las alarmas de un entorno de producción.&lt;/p&gt;
&lt;h2&gt;El token&lt;/h2&gt;
&lt;p&gt;Nuestro &lt;em&gt;bot&lt;/em&gt; es un ente propio, que tiene un &lt;em&gt;token&lt;/em&gt; de autenticación, de forma que solamente el que posea el &lt;em&gt;token&lt;/em&gt; pude responder como si fuera el &lt;em&gt;bot&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Para conseguir el &lt;em&gt;token&lt;/em&gt; tenemos que iniciar una conversación con &lt;strong&gt;@BotFather&lt;/strong&gt;, que es el &lt;em&gt;bot&lt;/em&gt; que gobierna al resto. La interfaz es muy simple, y vale la pena de explorar; de momento me limito a resumir los comandos necesarios:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Iniciamos una conversación con &lt;strong&gt;BotFather&lt;/strong&gt; mediante el comando &lt;em&gt;/start&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Le indicamos que queremos un nuevo &lt;em&gt;bot&lt;/em&gt; mediante el comando &lt;em&gt;/newbot&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Le damos un nombre y un &lt;em&gt;username&lt;/em&gt;, tal como nos lo pide.&lt;/li&gt;
&lt;li&gt;El último paso es anotar el &lt;em&gt;token&lt;/em&gt; que nos ofrece &lt;strong&gt;BotFather&lt;/strong&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Esto es todo lo que necesitamos para empezar a responder mensajes. Las conversaciones con el &lt;em&gt;bot&lt;/em&gt; se pueden iniciar buscando al &lt;em&gt;bot&lt;/em&gt; por su nombre o su &lt;em&gt;username&lt;/em&gt;. Obviamente, no tenemos nada todavía que responda a los &lt;em&gt;chats&lt;/em&gt; que se hagan a este nuevo &lt;em&gt;bot&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Hay dos formas de responder a este &lt;em&gt;bot&lt;/em&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Lo podemos configurar para que llame directamente a un &lt;em&gt;endpoint&lt;/em&gt; protegido con &lt;em&gt;HTTPS&lt;/em&gt; (requiere un certificado válido no autofirmado).&lt;/li&gt;
&lt;li&gt;Podemos tener un programa preguntando por nuevos mensajes periódicamente.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Como no tengo un servidor &lt;em&gt;HTTPS&lt;/em&gt; con certificado adecuado, vamos a ir por la segunda opción.&lt;/p&gt;
&lt;h2&gt;El script de respuesta&lt;/h2&gt;
&lt;p&gt;Vamos a escribir el &lt;em&gt;script&lt;/em&gt; en &lt;strong&gt;python&lt;/strong&gt; por su simplicidad y facilidad. Realmente se podría hacer con cualquier lenguaje, ya que se trata de hacer peticiones web a la &lt;em&gt;API&lt;/em&gt; e interpretarlas.&lt;/p&gt;
&lt;p&gt;Empezaremos por instalar una librería que nos va a facilitar bastante entender las peticiones y crear las respuestas. Lo vamos a hacer en un &lt;em&gt;virtualenv&lt;/em&gt; por limpieza.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gerard@sirius:~/projects/telebot$ virtualenv env
New python executable in /home/gerard/projects/telebot/env/bin/python
Installing setuptools, pip, wheel...done.
gerard@sirius:~/projects/telebot$ . env/bin/activate
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; gerard@sirius:~/projects/telebot$ pip install python-telegram-bot
Collecting python-telegram-bot
  Downloading python_telegram_bot-4.3.3-py2.py3-none-any.whl &lt;span class="o"&gt;(&lt;/span&gt;122kB&lt;span class="o"&gt;)&lt;/span&gt;
    100% &lt;span class="p"&gt;|&lt;/span&gt;████████████████████████████████&lt;span class="p"&gt;|&lt;/span&gt; 122kB 471kB/s 
Collecting certifi &lt;span class="o"&gt;(&lt;/span&gt;from python-telegram-bot&lt;span class="o"&gt;)&lt;/span&gt;
  Downloading certifi-2016.2.28-py2.py3-none-any.whl &lt;span class="o"&gt;(&lt;/span&gt;366kB&lt;span class="o"&gt;)&lt;/span&gt;
    100% &lt;span class="p"&gt;|&lt;/span&gt;████████████████████████████████&lt;span class="p"&gt;|&lt;/span&gt; 368kB 514kB/s 
Collecting urllib3&amp;gt;&lt;span class="o"&gt;=&lt;/span&gt;1.10 &lt;span class="o"&gt;(&lt;/span&gt;from python-telegram-bot&lt;span class="o"&gt;)&lt;/span&gt;
  Downloading urllib3-1.16-py2.py3-none-any.whl &lt;span class="o"&gt;(&lt;/span&gt;98kB&lt;span class="o"&gt;)&lt;/span&gt;
    100% &lt;span class="p"&gt;|&lt;/span&gt;████████████████████████████████&lt;span class="p"&gt;|&lt;/span&gt; 102kB 901kB/s 
Collecting future&amp;gt;&lt;span class="o"&gt;=&lt;/span&gt;0.15.2 &lt;span class="o"&gt;(&lt;/span&gt;from python-telegram-bot&lt;span class="o"&gt;)&lt;/span&gt;
Installing collected packages: certifi, urllib3, future, python-telegram-bot
Successfully installed certifi-2016.2.28 future-0.15.2 python-telegram-bot-4.3.3 urllib3-1.16
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; gerard@sirius:~/projects/telebot$ 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Realmente no hay mucho misterio; siguiendo la documentación se saca rápidamente un &lt;em&gt;script&lt;/em&gt;, al que llamaremos &lt;em&gt;run.py&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;telegram&lt;/span&gt;

&lt;span class="n"&gt;bot&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;telegram&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Bot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;token&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;190363978:AAG0bHpIbidczVYUPhW9UwrwG3n5s54XSlE&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getMe&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;process_update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;unknown&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;UPPER &amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;:]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;upper&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;chat_id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;chat_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;text&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;*Response*: &amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;parse_mode&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Markdown&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendMessage&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;last_update&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;last_update&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;updates&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getUpdates&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;updates&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;bot&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getUpdates&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;offset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;last_update&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;updates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;process_update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;last_update&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update_id&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;El &lt;em&gt;script&lt;/em&gt; es relativamente fácil de entender, así que solo os dejo algunas reflexiones:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;El &lt;em&gt;token&lt;/em&gt; usado en &lt;em&gt;telegram.Bot()&lt;/em&gt; es el que nos dio el &lt;strong&gt;BotFather&lt;/strong&gt; (ha sido destruido, así que no penséis en vandalizar).&lt;/li&gt;
&lt;li&gt;Los &lt;em&gt;update_id&lt;/em&gt; son secuenciales; sin embargo, varias lecturas a la &lt;em&gt;API&lt;/em&gt; nos vuelven a traer todos los mensajes. La forma de que no nos los vuelva a dar es especificando un parámetro &lt;em&gt;offset&lt;/em&gt; (aunque en la primera iteración no lo tenemos).&lt;/li&gt;
&lt;li&gt;Se ha decidido por procesar cada &lt;em&gt;update&lt;/em&gt; en una función aparte, ya que cada &lt;em&gt;bot&lt;/em&gt; hará algo diferente con ellos.&lt;/li&gt;
&lt;li&gt;Este &lt;em&gt;bot&lt;/em&gt; de prueba solo va a devolvernos el mensaje que le pasemos en mayúsculas, y solo si este empieza por "UPPER". El resto devuelve "unknown".&lt;/li&gt;
&lt;li&gt;Las respuestas pueden contener lenguaje &lt;em&gt;wiki&lt;/em&gt;, en este caso, &lt;strong&gt;markdown&lt;/strong&gt;; pueden también definir teclados a medida con las respuestas posibles.&lt;/li&gt;
&lt;li&gt;Las respuestas conocen a su receptor mediante el campo &lt;em&gt;chat_id&lt;/em&gt;. Este campo se puede ver como un indicador de sesión, si vuestro &lt;em&gt;bot&lt;/em&gt; mantiene el estado de un "jugador" concreto.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;La verdad es que es bastante simple la interfaz de la &lt;em&gt;API&lt;/em&gt;.  Con un poco de imaginación y una base de datos, es muy posible hacer un juego conversacional, sea con campos en la base de datos, o mediante una máquina de estados simple. Me quedo con esa idea para el futuro.&lt;/p&gt;</summary><category term="telegram"></category><category term="bots"></category><category term="python"></category></entry><entry><title>Consultando una base de datos Oracle en python</title><link href="http://www.linuxsysadmin.tk/2016/04/consultando-una-base-de-datos-oracle-en-python.html" rel="alternate"></link><published>2016-04-18T08:00:00+02:00</published><updated>2016-04-18T08:00:00+02:00</updated><author><name>Gerard</name></author><id>tag:www.linuxsysadmin.tk,2016-04-18:2016/04/consultando-una-base-de-datos-oracle-en-python.html</id><summary type="html">&lt;p&gt;El otro día estuve optimizando unos &lt;em&gt;scripts&lt;/em&gt; hechos en &lt;em&gt;bash&lt;/em&gt; que había hecho otro. Como resultado del lenguaje usado era un caos de comandos, muchos de ellos para limpiar la salida y darle la forma adecuada. Los reescribí en &lt;em&gt;python&lt;/em&gt; usando la librería &lt;strong&gt;cx_Oracle&lt;/strong&gt;, que compilé en un fichero &lt;em&gt;wheel&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;El mayor problema al que te enfrentas si intentas instalar una librería &lt;em&gt;python&lt;/em&gt; que no está en la librería estándar, es que debes usar el gestor de paquetes, previo uso del usuario &lt;strong&gt;root&lt;/strong&gt;. Y eso no siempre es posible.&lt;/p&gt;
&lt;p&gt;Así que para hacer una instalación en mi carpeta personal, me decanté por crear un &lt;strong&gt;virtualenv&lt;/strong&gt; en donde se iba a instalar una &lt;em&gt;wheel&lt;/em&gt; precompilada en una máquina similar. Lo documento para tenerlo a mano.&lt;/p&gt;
&lt;p&gt;Voy a explicar dos procedimientos: el primero es como instalar el &lt;em&gt;package&lt;/em&gt; en una máquina que tenga herramientas de compilación y como empaquetarlo en un fichero &lt;em&gt;wheel&lt;/em&gt;; el segundo consiste en instalar la &lt;em&gt;wheel&lt;/em&gt; localmente en la máquina que la va a usar, a modo de &lt;em&gt;runtime&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Para seguir esta guía, necesitamos una máquina con &lt;strong&gt;Linux&lt;/strong&gt; cualquiera, que en mi caso ha sido una &lt;strong&gt;Debian Jessie&lt;/strong&gt;. Estos son los paquetes necesarios como requisitos:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;unzip&lt;/li&gt;
&lt;li&gt;python&lt;/li&gt;
&lt;li&gt;libaio1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;En la máquina en donde se vaya a crear la &lt;em&gt;wheel&lt;/em&gt;, también serán necesarios los siguientes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;python-dev&lt;/li&gt;
&lt;li&gt;gcc&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Adicionalmente, se necesita descargar el &lt;a href="https://www.oracle.com/downloads/index.html"&gt;Oracle instant client&lt;/a&gt;, concretamente el &lt;strong&gt;basic&lt;/strong&gt; y, en caso de la construcción de la &lt;em&gt;wheel&lt;/em&gt;, también el &lt;strong&gt;sdk&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# ls -1
instantclient-basic-linux-12.1.0.2.0.zip
instantclient-sdk-linux-12.1.0.2.0.zip
root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Construyendo el fichero wheel&lt;/h2&gt;
&lt;p&gt;El primer paso consiste en descomprimir el &lt;em&gt;instant client&lt;/em&gt; de Oracle, necesario para cualquier programa que intente conectarse a sus bases de datos.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# unzip instantclient-basic-linux-12.1.0.2.0.zip
Archive:  instantclient-basic-linux-12.1.0.2.0.zip
  inflating: instantclient_12_1/adrci
  inflating: instantclient_12_1/BASIC_README
  inflating: instantclient_12_1/genezi
  inflating: instantclient_12_1/libclntshcore.so.12.1
  inflating: instantclient_12_1/libclntsh.so.12.1
  inflating: instantclient_12_1/libnnz12.so
  inflating: instantclient_12_1/libocci.so.12.1
  inflating: instantclient_12_1/libociei.so
  inflating: instantclient_12_1/libocijdbc12.so
  inflating: instantclient_12_1/libons.so
  inflating: instantclient_12_1/liboramysql12.so
  inflating: instantclient_12_1/ojdbc6.jar
  inflating: instantclient_12_1/ojdbc7.jar
  inflating: instantclient_12_1/uidrvci
  inflating: instantclient_12_1/xstreams.jar
root@oracle:~# unzip instantclient-sdk-linux-12.1.0.2.0.zip
Archive:  instantclient-sdk-linux-12.1.0.2.0.zip
   creating: instantclient_12_1/sdk/
   creating: instantclient_12_1/sdk/include/
  inflating: instantclient_12_1/sdk/include/oratypes.h
  inflating: instantclient_12_1/sdk/include/occi.h
  inflating: instantclient_12_1/sdk/include/ocikpr.h
  inflating: instantclient_12_1/sdk/include/odci.h
  inflating: instantclient_12_1/sdk/include/xa.h
  inflating: instantclient_12_1/sdk/include/ldap.h
  inflating: instantclient_12_1/sdk/include/oci.h
  inflating: instantclient_12_1/sdk/include/ocidfn.h
  inflating: instantclient_12_1/sdk/include/oci1.h
  inflating: instantclient_12_1/sdk/include/ort.h
  inflating: instantclient_12_1/sdk/include/ociextp.h
  inflating: instantclient_12_1/sdk/include/occiAQ.h
  inflating: instantclient_12_1/sdk/include/ori.h
  inflating: instantclient_12_1/sdk/include/nzerror.h
  inflating: instantclient_12_1/sdk/include/ocixmldb.h
  inflating: instantclient_12_1/sdk/include/ocidef.h
  inflating: instantclient_12_1/sdk/include/occiControl.h
  inflating: instantclient_12_1/sdk/include/ocidem.h
  inflating: instantclient_12_1/sdk/include/nzt.h
  inflating: instantclient_12_1/sdk/include/orid.h
  inflating: instantclient_12_1/sdk/include/ociap.h
  inflating: instantclient_12_1/sdk/include/orl.h
  inflating: instantclient_12_1/sdk/include/ocixstream.h
  inflating: instantclient_12_1/sdk/include/occiObjects.h
  inflating: instantclient_12_1/sdk/include/oci8dp.h
  inflating: instantclient_12_1/sdk/include/oro.h
  inflating: instantclient_12_1/sdk/include/occiCommon.h
  inflating: instantclient_12_1/sdk/include/ociapr.h
  inflating: instantclient_12_1/sdk/include/occiData.h
   creating: instantclient_12_1/sdk/admin/
  inflating: instantclient_12_1/sdk/admin/oraaccess.xsd
 extracting: instantclient_12_1/sdk/ottclasses.zip
   creating: instantclient_12_1/sdk/demo/
  inflating: instantclient_12_1/sdk/demo/occidemo.sql
  inflating: instantclient_12_1/sdk/demo/oraaccess.xml
  inflating: instantclient_12_1/sdk/demo/occiobj.cpp
  inflating: instantclient_12_1/sdk/demo/occidemod.sql
  inflating: instantclient_12_1/sdk/demo/occidml.cpp
  inflating: instantclient_12_1/sdk/demo/occiobj.typ
  inflating: instantclient_12_1/sdk/demo/setuporamysql.sh
  inflating: instantclient_12_1/sdk/demo/cdemo81.c
  inflating: instantclient_12_1/sdk/demo/demo.mk
  inflating: instantclient_12_1/sdk/ott
  inflating: instantclient_12_1/sdk/SDK_README
root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Para que el sistema sepa donde lo hemos descomprimido, hay que definir la variable de entorno &lt;strong&gt;ORACLE_HOME&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# &lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;ORACLE_HOME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/root/instantclient_12_1/
root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;La compilación de las librerías contenidas en el &lt;em&gt;package&lt;/em&gt; &lt;strong&gt;cx_Oracle&lt;/strong&gt; tiene un error y busca una librería llamada &lt;em&gt;libclntsh.so&lt;/em&gt;, que no se llama así en el &lt;em&gt;runtime&lt;/em&gt;. Se puede evitar el problema copiando la librería con el nuevo nombre, o mediante un enlace simbólico.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# &lt;span class="nb"&gt;cd&lt;/span&gt; instantclient_12_1/
root@oracle:~/instantclient_12_1# ln -s libclntsh.so.12.1 libclntsh.so
root@oracle:~/instantclient_12_1# &lt;span class="nb"&gt;cd&lt;/span&gt; ..
root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Y con esto ya podemos empezar. Creamos un &lt;strong&gt;virtualenv&lt;/strong&gt; que nos va a servir como plataforma de construcción del fichero &lt;em&gt;wheel&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# virtualenv env
New python executable in /root/env/bin/python
Installing setuptools, pip, wheel...done.
root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Se activa el entorno virtual y se instala la librería mediante &lt;strong&gt;pip&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle:~# . env/bin/activate
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# pip install cx_Oracle
Collecting cx-Oracle
  Using cached cx_Oracle-5.2.1.tar.gz
Building wheels &lt;span class="k"&gt;for&lt;/span&gt; collected packages: cx-Oracle
  Running setup.py bdist_wheel &lt;span class="k"&gt;for&lt;/span&gt; cx-Oracle ... &lt;span class="k"&gt;done&lt;/span&gt;
  Stored in directory: /root/.cache/pip/wheels/1f/38/66/b37c50906777b231a241ee02134f0ae018615519af43566269
Successfully built cx-Oracle
Installing collected packages: cx-Oracle
Successfully installed cx-Oracle-5.2.1
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Podemos verificar si funciona cargando el módulo, y por ejemplo, preguntando la versión del mismo.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# python -c &lt;span class="s2"&gt;&amp;quot;import cx_Oracle; print cx_Oracle.version&amp;quot;&lt;/span&gt;
Traceback &lt;span class="o"&gt;(&lt;/span&gt;most recent call last&lt;span class="o"&gt;)&lt;/span&gt;:
  File &lt;span class="s2"&gt;&amp;quot;&amp;lt;string&amp;gt;&amp;quot;&lt;/span&gt;, line 1, in &amp;lt;module&amp;gt;
ImportError: libclntsh.so.12.1: cannot open shared object file: No such file or directory
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Este es un mal resultado; nos indica que no se encuentra un fichero &lt;em&gt;.so&lt;/em&gt;. Este fichero está en &lt;strong&gt;ORACLE_HOME&lt;/strong&gt;, pero el sistema intenta buscar en &lt;strong&gt;LD_LIBRARY_PATH&lt;/strong&gt;. Con modificar esta variable de entorno funciona.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# &lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;LD_LIBRARY_PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$ORACLE_HOME&lt;/span&gt;:&lt;span class="nv"&gt;$LD_LIBRARY_PATH&lt;/span&gt;
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Otro error es que se queje de que no encuentra &lt;em&gt;libaio.so&lt;/em&gt;. Esto indica que os habéis saltado los requisitos y necesitáis instalarlos.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# python -c &lt;span class="s2"&gt;&amp;quot;import cx_Oracle; print cx_Oracle.version&amp;quot;&lt;/span&gt;
Traceback &lt;span class="o"&gt;(&lt;/span&gt;most recent call last&lt;span class="o"&gt;)&lt;/span&gt;:
  File &lt;span class="s2"&gt;&amp;quot;&amp;lt;string&amp;gt;&amp;quot;&lt;/span&gt;, line 1, in &amp;lt;module&amp;gt;
ImportError: libaio.so.1: cannot open shared object file: No such file or directory
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# apt-get install libaio1
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias
Leyendo la información de estado... Hecho
Se instalarán los siguientes paquetes NUEVOS:
  libaio1
&lt;span class="m"&gt;0&lt;/span&gt; actualizados, &lt;span class="m"&gt;1&lt;/span&gt; nuevos se instalarán, &lt;span class="m"&gt;0&lt;/span&gt; para eliminar y &lt;span class="m"&gt;0&lt;/span&gt; no actualizados.
Se necesita descargar 9.634 B de archivos.
Se utilizarán 13,3 kB de espacio de disco adicional después de esta operación.
...
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Finalmente obtenemos un resultado correcto, que nos indica que tenemos instalada la librería en nuestro entorno virtual.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# python -c &lt;span class="s2"&gt;&amp;quot;import cx_Oracle; print cx_Oracle.version&amp;quot;&lt;/span&gt;
5.2.1
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Podemos aprovechar esta compilación para máquinas con el mismo tipo de procesador y con la misma versión de &lt;strong&gt;python&lt;/strong&gt;, creando un fichero &lt;em&gt;wheel&lt;/em&gt; con la librería ya compilada.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~# pip wheel cx_Oracle
Collecting cx-Oracle
  Saved ./cx_Oracle-5.2.1-cp27-cp27mu-linux_i686.whl
Skipping cx-Oracle, due to already being wheel.
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle:~#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Y ese es el fichero que vamos a distribuir a los entornos de producción donde necesitemos crear &lt;em&gt;scripts&lt;/em&gt; en &lt;strong&gt;python&lt;/strong&gt; que se conecten a Oracle.&lt;/p&gt;
&lt;h2&gt;Instalando en otras máquinas&lt;/h2&gt;
&lt;p&gt;Vamos a suponer que nos interesa poner el &lt;em&gt;runtime&lt;/em&gt; de Oracle y la carpeta con nuestros &lt;em&gt;scripts&lt;/em&gt; en &lt;em&gt;/opt/&lt;/em&gt;. De hecho, nada impide que se haga en una carpeta personal, en la que tengamos privilegios completos.&lt;/p&gt;
&lt;p&gt;También vamos a necesitar un &lt;em&gt;instant client&lt;/em&gt; para poder funcionar, aunque esta vez no se necesitan enlaces simbólicos ni declarar la variable de entorno &lt;strong&gt;ORACLE_HOME&lt;/strong&gt;. Lo descargamos en su localización deseada.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle2:/opt# unzip /root/instantclient-basic-linux-12.1.0.2.0.zip
Archive:  /root/instantclient-basic-linux-12.1.0.2.0.zip
  inflating: instantclient_12_1/adrci
  inflating: instantclient_12_1/BASIC_README
  inflating: instantclient_12_1/genezi
  inflating: instantclient_12_1/libclntshcore.so.12.1
  inflating: instantclient_12_1/libclntsh.so.12.1
  inflating: instantclient_12_1/libnnz12.so
  inflating: instantclient_12_1/libocci.so.12.1
  inflating: instantclient_12_1/libociei.so
  inflating: instantclient_12_1/libocijdbc12.so
  inflating: instantclient_12_1/libons.so
  inflating: instantclient_12_1/liboramysql12.so
  inflating: instantclient_12_1/ojdbc6.jar
  inflating: instantclient_12_1/ojdbc7.jar
  inflating: instantclient_12_1/uidrvci
  inflating: instantclient_12_1/xstreams.jar
root@oracle2:/opt#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Las dependencias deberían estar ya instaladas, pero en mi caso no lo estaban. Las instalamos.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle2:/opt# apt-get install python libaio1
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias
Leyendo la información de estado... Hecho
Se instalarán los siguientes paquetes extras:
  file libexpat1 libffi6 libmagic1 libpython-stdlib libpython2.7-minimal libpython2.7-stdlib libsqlite3-0 mime-support
  python-minimal python2.7 python2.7-minimal
Paquetes sugeridos:
  python-doc python-tk python2.7-doc binutils binfmt-support
Se instalarán los siguientes paquetes NUEVOS:
  file libaio1 libexpat1 libffi6 libmagic1 libpython-stdlib libpython2.7-minimal libpython2.7-stdlib libsqlite3-0 mime-support
  python python-minimal python2.7 python2.7-minimal
&lt;span class="m"&gt;0&lt;/span&gt; actualizados, &lt;span class="m"&gt;14&lt;/span&gt; nuevos se instalarán, &lt;span class="m"&gt;0&lt;/span&gt; para eliminar y &lt;span class="m"&gt;0&lt;/span&gt; no actualizados.
Se necesita descargar 5.020 kB de archivos.
Se utilizarán 21,3 MB de espacio de disco adicional después de esta operación.
¿Desea continuar? &lt;span class="o"&gt;[&lt;/span&gt;S/n&lt;span class="o"&gt;]&lt;/span&gt; s
...  
root@oracle2:/opt#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Creamos la carpeta que va a contener el entorno virtual y los &lt;em&gt;scripts&lt;/em&gt;, y creamos en ella el entorno virtual.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle2:/opt# mkdir scripts
root@oracle2:/opt# &lt;span class="nb"&gt;cd&lt;/span&gt; scripts/
root@oracle2:/opt/scripts# virtualenv env
New python executable in /opt/scripts/env/bin/python
Installing setuptools, pip, wheel...done.
root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Activamos el entorno virtual y le instalamos el fichero &lt;em&gt;wheel&lt;/em&gt;, que habremos copiado en algún sitio. Este fichero es local a la máquina, y no se consulta el repositorio de &lt;strong&gt;python&lt;/strong&gt; remoto para nada. De hecho, un &lt;em&gt;wheel&lt;/em&gt; es un fichero &lt;em&gt;.zip&lt;/em&gt; normal, que se descomprime en la carpeta adecuada del &lt;strong&gt;virtualenv&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@oracle2:/opt/scripts# . env/bin/activate
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# pip install /root/cx_Oracle-5.2.1-cp27-cp27mu-linux_i686.whl
Processing /root/cx_Oracle-5.2.1-cp27-cp27mu-linux_i686.whl
Installing collected packages: cx-Oracle
Successfully installed cx-Oracle-5.2.1
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Probamos que funcione; es importante definir la variable de entorno &lt;strong&gt;LD_LIBRARY_PATH&lt;/strong&gt; para que encuentre el &lt;em&gt;runtime&lt;/em&gt; de Oracle. Es muy útil ponerlo en el fichero &lt;em&gt;~/.bashrc&lt;/em&gt; para que se cargue solo al abrir el &lt;em&gt;shell&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# &lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;LD_LIBRARY_PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/opt/instantclient_12_1/
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# python -c &lt;span class="s2"&gt;&amp;quot;import cx_Oracle; print cx_Oracle.version&amp;quot;&lt;/span&gt;
5.2.1
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Opcionalmente, podemos reducir la cantidad de librerías que conforman el &lt;em&gt;instant client&lt;/em&gt;, ya que solo se necesitan 4, y reduce su tamaño de forma dramática.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# du -sh /opt/instantclient_12_1/
169M    /opt/instantclient_12_1/
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Podemos ver que el &lt;em&gt;package&lt;/em&gt; &lt;strong&gt;cx_Oracle&lt;/strong&gt; es un fichero &lt;em&gt;.so&lt;/em&gt; y que este requiere de los otros 4 en el &lt;em&gt;runtime&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;(env) root@oracle2:/opt/scripts# find env/ -name &amp;quot;*.so&amp;quot;
env/lib/python2.7/site-packages/cx_Oracle.so
(env) root@oracle2:/opt/scripts# ldd env/lib/python2.7/site-packages/cx_Oracle.so | grep instant
        libclntsh.so.12.1 =&amp;gt; /opt/instantclient_12_1/libclntsh.so.12.1 (0xb5387000)
        libnnz12.so =&amp;gt; /opt/instantclient_12_1/libnnz12.so (0xb4d9d000)
        libons.so =&amp;gt; /opt/instantclient_12_1/libons.so (0xb4d69000)
        libclntshcore.so.12.1 =&amp;gt; /opt/instantclient_12_1/libclntshcore.so.12.1 (0xb4a90000)
(env) root@oracle2:/opt/scripts# ldd /opt/instantclient_12_1/lib{clntsh,nnz,ons}* | grep instant
/opt/instantclient_12_1/libclntshcore.so.12.1:
/opt/instantclient_12_1/libclntsh.so.12.1:
        libnnz12.so =&amp;gt; /opt/instantclient_12_1/libnnz12.so (0xb4f8c000)
        libons.so =&amp;gt; /opt/instantclient_12_1/libons.so (0xb4f58000)
        libclntshcore.so.12.1 =&amp;gt; /opt/instantclient_12_1/libclntshcore.so.12.1 (0xb4aec000)
/opt/instantclient_12_1/libnnz12.so:
        libclntshcore.so.12.1 =&amp;gt; /opt/instantclient_12_1/libclntshcore.so.12.1 (0xb7115000)
/opt/instantclient_12_1/libons.so:
(env) root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Lo que significa que debería ser seguro eliminar el resto. Así que lo hacemos. Guardad una copia de seguridad antes de eliminar nada.&lt;/p&gt;
&lt;p&gt;Tras eliminar lo que no nos sirve, la carpeta queda así:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# tree /opt/instantclient_12_1/
/opt/instantclient_12_1/
├── libclntshcore.so.12.1
├── libclntsh.so.12.1
├── libnnz12.so
└── libons.so

&lt;span class="m"&gt;0&lt;/span&gt; directories, &lt;span class="m"&gt;4&lt;/span&gt; files
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# du -sh /opt/instantclient_12_1/
55M     /opt/instantclient_12_1/
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;No está nada mal; hemos pasado de 169mb a 55mb. Comprobamos que sigue funcionando:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# python -c &lt;span class="s2"&gt;&amp;quot;import cx_Oracle; print cx_Oracle.version&amp;quot;&lt;/span&gt;
5.2.1
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Y parece correcto.&lt;/p&gt;
&lt;h2&gt;Uso del package cx_Oracle&lt;/h2&gt;
&lt;p&gt;En este punto hay que seguir la documentación del módulo, que no es muy diferente de otras bases de datos; &lt;strong&gt;cx_Oracle&lt;/strong&gt; sigue la misma especificación para todos los módulos de bases de datos.&lt;/p&gt;
&lt;p&gt;La idea es que se crea un objeto &lt;strong&gt;conexión&lt;/strong&gt;, del que se saca un &lt;strong&gt;cursor&lt;/strong&gt; para cada consulta que queramos ejecutar, y que se itera para obtener las &lt;strong&gt;filas&lt;/strong&gt;. Pongamos un ejemplo simple:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# cat list_fruits.py
&lt;span class="c1"&gt;#!/usr/bin/env python&lt;/span&gt;

import cx_Oracle

&lt;span class="nv"&gt;HOST&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;my_host&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;PORT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;my_port&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;SID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;my_sid&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;SERVICE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;my_service_name&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;USER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;nobody&amp;#39;&lt;/span&gt;
&lt;span class="nv"&gt;PASSWORD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;secret&amp;#39;&lt;/span&gt;

&lt;span class="nv"&gt;dsn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; cx_Oracle.makedsn&lt;span class="o"&gt;(&lt;/span&gt;HOST, PORT, SID, SERVICE&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="nv"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; cx_Oracle.connect&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;USER, &lt;span class="nv"&gt;password&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;PASSWORD, &lt;span class="nv"&gt;dsn&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dsn&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="nv"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;select name, price from fruits&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;cursor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; connection.cursor&lt;span class="o"&gt;()&lt;/span&gt;
cursor.execute&lt;span class="o"&gt;(&lt;/span&gt;query&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; row in cursor:
    print &lt;span class="s1"&gt;&amp;#39;;&amp;#39;&lt;/span&gt;.join&lt;span class="o"&gt;(&lt;/span&gt;row&lt;span class="o"&gt;)&lt;/span&gt;
cursor.close&lt;span class="o"&gt;()&lt;/span&gt;

connection.close&lt;span class="o"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ejecutamos como cualquier otro &lt;em&gt;script&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts# ./list_fruits.py
Apple&lt;span class="p"&gt;;&lt;/span&gt;0.99
Orange&lt;span class="p"&gt;;&lt;/span&gt;0.89
Pear&lt;span class="p"&gt;;&lt;/span&gt;1.19
&lt;span class="o"&gt;(&lt;/span&gt;env&lt;span class="o"&gt;)&lt;/span&gt; root@oracle2:/opt/scripts#
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Y obtenemos los datos deseados, con la facilidad que nos aporta &lt;strong&gt;python&lt;/strong&gt; para dar formato fácil a la salida de nuestros &lt;em&gt;scripts&lt;/em&gt;.&lt;/p&gt;</summary><category term="linux"></category><category term="debian"></category><category term="jessie"></category><category term="python"></category><category term="oracle"></category><category term="script"></category><category term="virtualenv"></category><category term="wheel"></category></entry></feed>